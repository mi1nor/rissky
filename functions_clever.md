`1. Введение`

С помощью платформы Клевер, вы можете написать практически все что хотите, конечно же, в рамках разумного. Вы можете написать полностью свой код, который будет сочетаться с автономным полетом и под ваши задачи, которые вы хотите сделать, то он скорее всего будет работать так, как вы и задумывали.
Если же вы хотите внести какой-то вклад или придумать что-то новое, то вы можете сделать свой проект. В этом курсе будет модуль рой, который полностью относится как проект. То есть, разработчики Клевера его не разрабатывали, а только лишь сами пользователи.
В этом уроке мы разберем самые базовые и нужные функции Клевера, которые могут вам помочь при написании кода для автономного полета.

`2. Получения значения с топиков`

У нашего дрона Клевера есть куча разных топиков. Дрон передает значения и публикует их в топик. Условно, у нас есть лазерный дальномер и он у нас подключен. Все значения, включая высота и даже сколько он уже работает: публикоуются в топик. Сейчас мы и узнаем, как получить значения с топика, вы сможете получать значения с любого топика которого захотите.

С помощью этих значений, вы можете их включить в ваш код для автономного полета, которые могут вам помочь. Допустим, на поле есть платформа и нам нужно узнать, где она находится. Эта платформа с высотой 0.5 метра. Когда наш дрон летает, то мы можем сделать, если условно высота ниже 1 метра, то он узнает, что тут платформа. Но получения высоты с телеметрии нам тут не поможет, ибо будет писать нашу высоту 1.5 метр, когда дальномер 1 и ниже, ибо сама платформа 0.5 метра. Это одно из применений значения из топика.

В самом последнем образе вы можете смотреть все топики, перейдя во вкладку "View topics" зайдя перед этим в браузер и открыв специальную ссылку. Здесь вы увидете все топики, где наш Клевер передает значения. Давайте же перейдем в топик "/rangefinder/range". Это наш дальномер.

img...

Так же вы можете узнать значения и в самом терминале, это можно сделать через команду "rostopic echo /rangefinder/range".

Здесь вы видите, как публикуются разные значения. Самый нужный из этих является "range", или же высота, все остальные нам не понадобятся. Если же вы хотите узнать в терминале только "range", то есть высоту, то вам придется уже написать "rostopic echo /rangefinder/range/range".

img...

Давайте же теперь напишем код, который будет брать эти значения из топиков.

Нам нужно будет написать код, где будет браться подписка на наш топик, который нужен и брать с него значения. Но чтобы взять подписку и получить значения, нужно подключить библиотеки. Это можно легко сделать. Вы должны открыть сам топик, и рядом с его названием будет по типу "sensor_msgs/Range". вы должны будете написать "from sensor_msgs.msg import Range", и так вы должны будете сделать со всеми топиками, просто поставить свои значения.

```
from sensor_msgs.msg import Range # Вставляем где библиотеки

z_dist = 0 # Иницилизируем
def range_callback(msg): # Делаем функцию, где msg будет брать "команды", то есть range
    global z_dist # Делаем ее глобальной чтобы потом куда-то можно было вставить
    z_dist = msg.range # Берет значение

rospy.Subscriber('rangefinder/range', Range, range_callback) # Берем значение из топика
```

Потом, с этим кодом вы можете делать что хотите. z_dist будет постоянно обновляться и брать нынешнею высоту. Если же вы хотите взять условно сколько секунд уже прошло, то надо будет написать так, эти значения вы можете увидеть в топике:

```
    z_dist = msg.header.stamp.secs # вместо z_dist = msg.range
```

Чтобы вывести нынешнею высоту, вы можете просто добавить это в функцию main() и сделать так:

```
print("Z = {}".format(z_dist))
```

`3. LED-лента, подсветка`

Давайте же теперь познакомимся с другой "функцией" клевера, - подсветка. Для этого, нам понадобится LED-лента, она идет в комплекте с дроном, поэтому она у вас должна быть обязательно.

При установке образа, подсветка изначально стоит на параметре "true". Поэтому, если у вас сама LED-лента подключена к 21 пину по GPIO, то при полном запуске образа, она должна у вас гореть радугой.

Давайте же разберемся, как теперь управлять подсветкой. Для этого, мы напишем маленькую программу.

Для того, чтобы ей управлять, нужно всего-лишь подключить библиотку, которая будет менять эту подсветку и просто сами потом будем изменять. Все очень просто:

```
import rospy
from clover.srv import SetLEDEffect # Подключение библиотеки для подцветки

rospy.init_node('flight')

set_effect = rospy.ServiceProxy('led/set_effect', SetLEDEffect)  # Чтобы ею управлять, LED-лентой


set_effect(r=255, g=0, b=0)  # Изменить цвет на красный

rospy.sleep(5) # Подсветка поставится на 5 секунд

set_effect(effect='rainbow') # Радуга

rospy.sleep(5) # Подсветка поставится на 5 секунд

set_effect(effect='fade', r=0, g=0, b=255) # Градиент с голубым цветом
```

Познакомимся с двумя параметрами подцветки: это effect, и rgb (red, green, blue).

Вы можете использовать как просто rgb, так просто effect, но можете еще их сочетать еще и вместе. Я подобрал все варианты в коде сверху. Самый максимальное значение для красного или зеленого или голубого, это 255. Если же вы хотите поставить условно фиолетовый цвет, то лучше использовать онлайн сервисы по выбору цвета, где будет показано значение в rgb, которое вы должны вставить.

`4. Замедление процесса`

Некоторые наши модули по типу компьютерного зрения, могут слишком сильно нагружать наш процессор в Raspberry Pi. Поэтому, для лучшей производительности дрона, лучше всего использовать замедления кадров, чтобы наш процессор не так сильно перегружался.

```
<node pkg="topic_tools" name="cam_throttle" type="throttle"
    args="messages main_camera/image_raw 5.0 main_camera/image_raw_throttled"/>
```

Этот параметр вы должны добавить в той директории, где же вы и открывали и aruco.launch, только файл, где нужно будет это добавить, называется main_camera.launch

img...

`5. Optical Flow`

Давайте предположим, что на нашем поле нет Aruco меток. Тогда же как нам быть, если мы постоянно используем навигацию по маркерам, то есть по Aruco.

Для этого, и был создан Optical Flow, чтобы летать по полю, где нет Aruco меток. Данная технология, основана на вычислении сдвигов между соседними кадрами с камеры и передачи этой информации в полетный контроллер для дальнейшего расчета смещения дрона относительно изначальной точки.

Для того, чтобы ее включить, вы должны перейти в файл clover.launch, по той самой директории, и увидеть параметр "optical_flow" и поставить значение на "true".

Для того, чтобы его использовать на дроне, то просто делайте ориентацию в navigate не по "aruco_map", а просто по "body".
